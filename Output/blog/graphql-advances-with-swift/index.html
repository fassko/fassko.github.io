<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Kristaps Grinbergs"/><link rel="canonical" href="https://kristaps.me/blog/graphql-advances-with-swift"/><meta name="twitter:url" content="https://kristaps.me/blog/graphql-advances-with-swift"/><meta name="og:url" content="https://kristaps.me/blog/graphql-advances-with-swift"/><title>GraphQL Advances when fetching data in iOS with Swift and Apollo SDK | Kristaps Grinbergs</title><meta name="twitter:title" content="GraphQL Advances when fetching data in iOS with Swift and Apollo SDK | Kristaps Grinbergs"/><meta name="og:title" content="GraphQL Advances when fetching data in iOS with Swift and Apollo SDK | Kristaps Grinbergs"/><meta name="description" content="In previous articles, we discussed how to [get started](/graphql-ios-swift/) with  and use [subscriptions](/graphql-subscriptions/) with GraphQL in iOS (and iPadOS, tvOS, and macOS) using Swift programming language."/><meta name="twitter:description" content="In previous articles, we discussed how to [get started](/graphql-ios-swift/) with  and use [subscriptions](/graphql-subscriptions/) with GraphQL in iOS (and iPadOS, tvOS, and macOS) using Swift programming language."/><meta name="og:description" content="In previous articles, we discussed how to [get started](/graphql-ios-swift/) with  and use [subscriptions](/graphql-subscriptions/) with GraphQL in iOS (and iPadOS, tvOS, and macOS) using Swift programming language."/><meta name="og:site_name" content="Kristaps Grinbergs - iOS and Apple technology developer. Startup founder. Conference speaker."/><meta name="og:title" content="Kristaps Grinbergs - iOS and Apple technology developer. Startup founder. Conference speaker."/><meta name="og:description" content="Kristaps Grinbergs - iOS and Apple technology developer. Startup founder. Conference speaker."/><meta name="og:image" content="linkedin.png"/><meta name="og:type" content="website"/><meta name="og:url" content="https://kristaps.me"/><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@fassko"/><meta name="twitter:title" content="Kristaps Grinbergs"/><meta name="twitter:description" content="Kristaps Grinbergs - iOS and Apple technology developer. Startup founder. Conference speaker."/><meta name="twitter:image" content="fb-og.png"/><link href="https://fonts.gstatic.com" rel="preconnect"/><link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap" rel="stylesheet"/><link rel="apple-touch-icon-precomposed" sizes="120x120" href="apple-touch-icon-120x120.png"/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Kristaps Grinbergs"/></head><body><header class="header"><div class="header-wrapper"><div class="main-title"><a href="/">Kristaps Grinbergs</a></div><nav class="nav-container"><nav><ul class="nav"><li class="nav-item"><a href="/">home</a></li><li class="nav-item"><a href="/blog">blog</a></li><li class="nav-item"><a href="/talks">talks</a></li><li class="nav-item"><a href="/about">about</a></li></ul></nav></nav></div></header><div class="wrapper"><section class="blog-list"><div class="blog-item"><h1 class="blog-title">GraphQL Advances when fetching data in iOS with Swift and Apollo SDK</h1><div class="blog-date">27 Dec 2019</div><div class="blog-content"><p>In previous articles, we discussed how to <a href="/graphql-ios-swift/">get started</a> with and use <a href="/graphql-subscriptions/">subscriptions</a> with GraphQL in iOS (and iPadOS, tvOS, and macOS) using Swift programming language.</p><p>This time I want to discuss some advanced topics using GraphQL with Apollo SDK and Swift: usage of GraphQL fragments and Swift scalar types; optionality with GraphQL and it’s pros and cons.</p><h2>Using fragments</h2><p>At first, what is a <strong>fragment</strong> in GraphQL? It is a reusable piece of the query. For instance, if you need the same field in multiple queries you can extract that into a reusable piece called <a href="https://graphql.org/learn/queries/#fragments">GraphQL fragment</a>.</p><pre><code class="language-no-highlight">query Users($id: userID) {
  users(id $id) {
    ...UserDetails
    followers {
      ...UserDetails
    }
  }
}

fragment UserDetails on User {
  id
  firstName
  lastName
  email
}
</code></pre><p>When you use fragments in your Swift project queries, Apollo iOS SDK <a href="https://www.apollographql.com/docs/ios/fragments/">generates separate result types</a>. It is a good way to divide UI, for instance, UITableViewCell or UICollectionViewCell. This way a child view can be reused and only depends on the parent - UITableView or UICollectionView.</p><h2>GraphQL scalar types in Swift</h2><p>In GraphQL a <a href="https://graphql.org/learn/schema/#scalar-types">scalar type</a> is a field that has to resolve to some concrete type. In Swift language it can be <code>Date</code> or <code>enum</code>. Once you download schema JSON file you can see it like this:</p><pre><code class="language-no-highlight">"type": {
  "kind": "SCALAR",
  "name": "Date",
  "ofType": null
}
</code></pre><p>Using Apollo code generation argument <code>--passthroughCustomScalars</code> you can use your own types for custom scalars.</p><p>Swift <code>Date</code> type from Foundation framework is a good example. If you want to convert GraphQL Date type to Swift using Apollo iOS SDK, just pass <code>--passthroughCustomScalars</code> when generating the Swift code.</p><p>You can use custom formats for <code>Date</code> like <code>ISO8601</code> or use milliseconds. You just need to extend <code>Date</code> type and conform to <code>JSONDecodable</code> which requires implementing the initializing method.</p><pre><code><span class="keyword">extension</span> <span class="type">Date</span>: <span class="type">JSONDecodable</span> {
  <span class="keyword">public init</span>(jsonValue value: <span class="type">JSONValue</span>) <span class="keyword">throws</span> {
    <span class="keyword">guard let</span> isoString = value <span class="keyword">as</span>? <span class="type">String</span> <span class="keyword">else</span> {
      <span class="keyword">throw</span> <span class="type">JSONDecodingError</span>.<span class="call">couldNotConvert</span>(value: value, to: <span class="type">Date</span>.<span class="keyword">self</span>)
    }
    
    <span class="keyword">var</span> tmpDate: <span class="type">Date</span>?
    <span class="keyword">if</span> isoString.<span class="property">count</span> == <span class="number">17</span> {
      tmpDate = <span class="type">DateFormatter</span>.<span class="type">ISO8601short</span>.<span class="call">date</span>(from: isoString)
    } <span class="keyword">else if</span> isoString.<span class="property">count</span> == <span class="number">24</span> {
      tmpDate = <span class="type">DateFormatter</span>.<span class="type">ISO8601Milliseconds</span>.<span class="call">date</span>(from: isoString)
    } <span class="keyword">else</span> {
      tmpDate = <span class="type">DateFormatter</span>.<span class="type">ISO8601</span>.<span class="call">date</span>(from: isoString)
    }
    
    <span class="keyword">guard let</span> date = tmpDate <span class="keyword">else</span> {
      <span class="keyword">throw</span> <span class="type">JSONDecodingError</span>.<span class="call">couldNotConvert</span>(value: value, to: <span class="type">Date</span>.<span class="keyword">self</span>)
    }
    <span class="keyword">self</span> = date
  }
}
</code></pre><p><code>ISO8601short</code>, <code>ISO8601Milliseconds</code> and <code>ISO8601</code> declared in DateFormatter type extension as static instance properties.</p><h2>Dealing with optionals with GraphQL</h2><p>I think that optional type properties is one of the biggest downsides of the GraphQL with Apollo iOS SDK. It is so because in many cases GraphQL type field can not be specified, so it can be null.</p><p>When you are <a href="https://www.apollographql.com/docs/ios/fetching-queries/">fetching queries</a> with Apollo iOS SDK <code>GraphQLResult</code> type has optional property <code>data</code>. This property is a typed result data which means it has fetched type properties and those can be also optional.</p><p>This optional hell can be solved using extension for a specific type and add optional initializer:</p><pre><code><span class="keyword">extension</span> <span class="type">User</span> {  
  <span class="keyword">init</span>?(<span class="keyword">_</span> user: <span class="type">UsersQuery</span>.<span class="type">Data</span>.<span class="type">User</span>) {
    <span class="keyword">guard let</span> userID = <span class="type">Int</span>(user.<span class="property">id</span>) <span class="keyword">else</span> {
      <span class="keyword">return nil</span>
    }
    
    <span class="keyword">self</span>.<span class="property">id</span> = userID
    <span class="keyword">self</span>.<span class="property">firstName</span> = user.<span class="property">firstName</span>
    <span class="keyword">self</span>.<span class="property">lastName</span> = user.<span class="property">lastName</span>
    <span class="keyword">self</span>.<span class="property">email</span> = user.<span class="property">email</span>
  }
}
</code></pre><p>You can use this initializer when you fetch data and transform it from GraphQL types to your app models. By abstracting this with another layer you can hide it away and return, let’s say, a Swift Result type.</p><h2>TL;DR</h2><p>GraphQL fragments is a great way to extract some parts of the query code and reuse it in multiple places. Using Apollo iOS SDK it will generate Swift code for your apps and projects.</p><p>Converting types like GraphQL <code>Date</code> to Swift <code>Date</code> is a great hidden gem in Apollo iOS SDK. All you need to do is to add argument <code>--passthroughCustomScalars</code> during code generation.</p><p>Dealing with optionals can be a pain with GraphQL in your Swift projects. One way to improve the code base is to use custom initializers for your models.</p><h2>Links</h2><ul><li><a href="https://www.apollographql.com/docs/ios/fragments/">Using GraphQL fragments</a></li><li><a href="https://github.com/apollographql/apollo-tooling">Tooling for development and production Apollo workflows</a></li><li><a href="https://www.apollographql.com/docs/ios/fetching-queries/">Fetching queries</a></li><li><a href="https://blog.apollographql.com/mapping-graphql-types-to-swift-aa85e5693db4">Mapping GraphQL types to Swift</a></li><li><a href="https://github.com/apollographql/apollo-ios/issues/450">Add support for Date Type in Apollo iOS SDK</a></li></ul></div></div></section></div><footer class="footer">Copyright © Kristaps Grinbergs. 2020</footer></body></html>