<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Kristaps Grinbergs"/><link rel="canonical" href="https://kristaps.me/blog/clearing-subscriptions"/><meta name="twitter:url" content="https://kristaps.me/blog/clearing-subscriptions"/><meta name="og:url" content="https://kristaps.me/blog/clearing-subscriptions"/><title>Clearing up after subscribing to Swift WebSockets | Kristaps Grinbergs</title><meta name="twitter:title" content="Clearing up after subscribing to Swift WebSockets | Kristaps Grinbergs"/><meta name="og:title" content="Clearing up after subscribing to Swift WebSockets | Kristaps Grinbergs"/><meta name="description" content="Opening and keeping a WebSocket connection alive isn't enough when dealing with it. The connection needs to be closed either from user or sever side. That is [mentioned](https://tools.ietf.org/html/draft-hixie-thewebsocketprotocol-76#section-6) in the official WebSocket protocol."/><meta name="twitter:description" content="Opening and keeping a WebSocket connection alive isn't enough when dealing with it. The connection needs to be closed either from user or sever side. That is [mentioned](https://tools.ietf.org/html/draft-hixie-thewebsocketprotocol-76#section-6) in the official WebSocket protocol."/><meta name="og:description" content="Opening and keeping a WebSocket connection alive isn't enough when dealing with it. The connection needs to be closed either from user or sever side. That is [mentioned](https://tools.ietf.org/html/draft-hixie-thewebsocketprotocol-76#section-6) in the official WebSocket protocol."/><meta name="og:site_name" content="Kristaps Grinbergs - iOS and Apple technology developer. Startup founder. Conference speaker."/><meta name="og:title" content="Kristaps Grinbergs - iOS and Apple technology developer. Startup founder. Conference speaker."/><meta name="og:description" content="Kristaps Grinbergs - iOS and Apple technology developer. Startup founder. Conference speaker."/><meta name="og:image" content="linkedin.png"/><meta name="og:type" content="website"/><meta name="og:url" content="https://kristaps.me"/><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@fassko"/><meta name="twitter:title" content="Kristaps Grinbergs"/><meta name="twitter:description" content="Kristaps Grinbergs - iOS and Apple technology developer. Startup founder. Conference speaker."/><meta name="twitter:image" content="fb-og.png"/><link href="https://fonts.gstatic.com" rel="preconnect"/><link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap" rel="stylesheet"/><link rel="apple-touch-icon-precomposed" sizes="120x120" href="apple-touch-icon-120x120.png"/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Kristaps Grinbergs"/></head><body><header class="header"><div class="header-wrapper"><div class="main-title"><a href="/">Kristaps Grinbergs</a></div><nav class="nav-container"><nav><ul class="nav"><li class="nav-item"><a href="/">home</a></li><li class="nav-item"><a href="/blog">blog</a></li><li class="nav-item"><a href="/talks">talks</a></li><li class="nav-item"><a href="/about">about</a></li></ul></nav></nav></div></header><div class="wrapper"><section class="blog-list"><div class="blog-item"><h1 class="blog-title">Clearing up after subscribing to Swift WebSockets</h1><div class="blog-date">25 Feb 2020</div><div class="blog-content"><p>Opening and keeping a WebSocket connection alive isn't enough when dealing with it. The connection needs to be closed either from user or sever side. That is <a href="https://tools.ietf.org/html/draft-hixie-thewebsocketprotocol-76#section-6">mentioned</a> in the official WebSocket protocol.</p><p>Previously we have seen how to implement WebSockets using <a href="/websockets-swift/">Starscream library</a>, <a href="/websockets-ios-13-swift/">URLSessionWebSocketTask</a> and <a href="https://kristaps.me/graphql-subscriptions/">GraphQL</a> in Swift projects. This time we will look into cleaning up the connection after you don’t need it anymore.</p><p>If you leave the connection open and don’t clean up properly various problems can arise: memory leaks, server overworking and data corruptions.</p><h2>Closing the WebSocket</h2><p>As we are looking at how to close connection from user agent there are couple of things to consider. When closing the connection we need to inform server about the reason using "close" code which can be useful for server developers. There are several "close" codes which you can check out in <a href="https://tools.ietf.org/html/rfc6455#section-7.4.1">RFC 6455</a> specification or simplified version <a href="https://developer.mozilla.org/en-US/docs/Web/API/CloseEvent">here</a>.</p><p>If anything goes wrong with the connection on user side connection should be closed. It is important to note that when user agent notices that server has closed its connection, it should do the same on the other side. That means you need to explicitly inform the server about such event (regardless of the closure on the user side). That is clearly <a href="https://tools.ietf.org/html/draft-hixie-thewebsocketprotocol-76#section-6.3">stated</a> in the official WebSocket protocol.</p><h2>Cancel the URLSessionWebSocketTask</h2><p>To cancel a <code>URLSessionWebSocketTask</code> you need to call a <code>cancel</code> <a href="https://developer.apple.com/documentation/foundation/urlsessionwebsockettask/3181200-cancel">method</a>.</p><p>When calling this instance method you need to provide a <a href="https://developer.apple.com/documentation/foundation/urlsessionwebsockettask/closecode">close code</a> and a reason.</p><pre><code><span class="keyword">let</span> url = <span class="type">URL</span>(string: <span class="string">"wss://echo.websocket.org"</span>)!
<span class="keyword">let</span> webSocketTask = <span class="type">URLSession</span>.<span class="property">shared</span>.<span class="call">webSocketTask</span>(with: url)

<span class="comment">// ...</span>

webSocketTask.<span class="call">cancel</span>(with: .<span class="dotAccess">goingAway</span>, reason: <span class="keyword">nil</span>)
</code></pre><h2>Disconnect with Starscream</h2><p>To close a WebSocket created with library <a href="https://github.com/daltoniam/Starscream">Starscream</a> you need to call a <code>disconnect</code> method. If you want to specify it in the close code you can do so, but it is optional.</p><pre><code><span class="keyword">let</span> socket = <span class="type">WebSocket</span>(url: <span class="type">URL</span>(string: <span class="string">"ws://localhost:8080/"</span>)!)

<span class="comment">// ...</span>

socket.<span class="call">disconnect</span>(closeCode: <span class="type">CloseCode</span>.<span class="property">normal</span>.<span class="property">rawValue</span>)
</code></pre><h2>Cancel subscriptions with GraphQL</h2><p>When using GraphQL with subscriptions Apollo protocol handles all the heavy duty work behind the scenes. Clients can get immediate data changes from the server.</p><p>In Apollo iOS SDK library subscriptions are <code>Cancellable</code> <a href="https://github.com/apollographql/apollo-ios/Sources/Apollo/Cancellable.swift">protocol</a> types. It is an object that can be cancelled when in progress and it has just one method <code>cancel</code>.</p><p>In order to clean up after GraphQL subscriptions are not needed anymore the easiest way is to keep track of all subscriptions and cancel when needed or do the cleanup within object <code>deinit</code> method.</p><pre><code><span class="keyword">var</span> subscriptions: [<span class="type">Cancellable</span>]

<span class="comment">// ...</span>

<span class="keyword">let</span> newPricesSubcriprion = <span class="type">ApolloClient</span>.<span class="call">subscribe</span>(<span class="type">NewPricesSubscription</span>()) { ... }

<span class="comment">// ...</span>

subscriptions.<span class="call">forEach</span> { subscription <span class="keyword">in</span>
    subscription.<span class="call">cancel</span>()
}
</code></pre><h2>TL;DR</h2><p>When working with WebSockets we need to remember to close connections and clean up. Forgetting to do so we can run into multiple issues which can later be hard to debug and understand.</p><p>We can use WebSockets in our Swift projects in multiple ways and each one requires a different approach to close the connection. But most importantly as WebSocket protocol tells us we need to do it either connection is closed from the user or server side.</p><h2>Links</h2><ul><li><a href="https://tools.ietf.org/html/draft-hixie-thewebsocketprotocol-76#section-6">Closing the connection from WebSocket protocol</a></li><li><a href="https://developer.apple.com/documentation/foundation/urlsessionwebsockettask/3181200-cancel">Cancel URLSessionWebSocketTask</a></li><li><a href="https://github.com/daltoniam/Starscream">Starscream library documentation</a></li><li><a href="https://www.apollographql.com/docs/ios/subscriptions/">GraphQL subscriptions</a></li></ul></div></div></section></div><footer class="footer">Copyright © Kristaps Grinbergs. 2020</footer></body></html>