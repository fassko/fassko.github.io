<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Kristaps Grinbergs"/><link rel="canonical" href="https://kristaps.me/blog/graphql-subscriptions"/><meta name="twitter:url" content="https://kristaps.me/blog/graphql-subscriptions"/><meta name="og:url" content="https://kristaps.me/blog/graphql-subscriptions"/><title>How to use subscriptions with GraphQL using Apollo iOS SDK and Swift | Kristaps Grinbergs</title><meta name="twitter:title" content="How to use subscriptions with GraphQL using Apollo iOS SDK and Swift | Kristaps Grinbergs"/><meta name="og:title" content="How to use subscriptions with GraphQL using Apollo iOS SDK and Swift | Kristaps Grinbergs"/><meta name="description" content="GraphQL main functionality is to fetch and update data from the server. In addition to that subscriptions allow us to listen and to send messages from and to server in real-time. It is similar to regular queries, but the answer will be received when an event happens either on the server or on the client. Apollo iOS SDK library supports subscriptions and it is powered by the Swift WebSocket library [Starscream](/websockets-swift/) behind the scenes to connect to the server. Let's look at how to set it up and start using it."/><meta name="twitter:description" content="GraphQL main functionality is to fetch and update data from the server. In addition to that subscriptions allow us to listen and to send messages from and to server in real-time. It is similar to regular queries, but the answer will be received when an event happens either on the server or on the client. Apollo iOS SDK library supports subscriptions and it is powered by the Swift WebSocket library [Starscream](/websockets-swift/) behind the scenes to connect to the server. Let's look at how to set it up and start using it."/><meta name="og:description" content="GraphQL main functionality is to fetch and update data from the server. In addition to that subscriptions allow us to listen and to send messages from and to server in real-time. It is similar to regular queries, but the answer will be received when an event happens either on the server or on the client. Apollo iOS SDK library supports subscriptions and it is powered by the Swift WebSocket library [Starscream](/websockets-swift/) behind the scenes to connect to the server. Let's look at how to set it up and start using it."/><meta name="og:site_name" content="Kristaps Grinbergs - iOS and Apple technology developer. Startup founder. Conference speaker."/><meta name="og:title" content="Kristaps Grinbergs - iOS and Apple technology developer. Startup founder. Conference speaker."/><meta name="og:description" content="Kristaps Grinbergs - iOS and Apple technology developer. Startup founder. Conference speaker."/><meta name="og:image" content="linkedin.png"/><meta name="og:type" content="website"/><meta name="og:url" content="https://kristaps.me"/><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@fassko"/><meta name="twitter:title" content="Kristaps Grinbergs"/><meta name="twitter:description" content="Kristaps Grinbergs - iOS and Apple technology developer. Startup founder. Conference speaker."/><meta name="twitter:image" content="fb-og.png"/><link href="https://fonts.gstatic.com" rel="preconnect"/><link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap" rel="stylesheet"/><link rel="apple-touch-icon-precomposed" sizes="120x120" href="apple-touch-icon-120x120.png"/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Kristaps Grinbergs"/></head><body><header class="header"><div class="header-wrapper"><div class="main-title"><a href="/">Kristaps Grinbergs</a></div><nav class="nav-container"><nav><ul class="nav"><li class="nav-item"><a href="/">home</a></li><li class="nav-item"><a href="/blog">blog</a></li><li class="nav-item"><a href="/talks">talks</a></li><li class="nav-item"><a href="/about">about</a></li></ul></nav></nav></div></header><div class="wrapper"><section class="blog-list"><div class="blog-item"><h1 class="blog-title">How to use subscriptions with GraphQL using Apollo iOS SDK and Swift</h1><div class="blog-date">26 Nov 2019</div><div class="blog-content"><p>GraphQL main functionality is to fetch and update data from the server. In addition to that subscriptions allow us to listen and to send messages from and to server in real-time. It is similar to regular queries, but the answer will be received when an event happens either on the server or on the client.</p><p>Apollo iOS SDK library supports subscriptions and it is powered by the Swift WebSocket library <a href="/websockets-swift/">Starscream</a> behind the scenes to connect to the server. Let's look at how to set it up and start using it.</p><h2>Schema and code generation</h2><p>Subscriptions are already supported once you download your schema file from the GraphQL server and perform the code generation. It will generate all the subscriptions using <code>GraphQLSubscription</code> protocol which allows passing parameters to subscription you want to implement.</p><p>Let’s imagine we have a chat application and GraphQL server can get messages for a specific thread as soon as they are sent. We need to create a GraphQL query in our <code>.graphql</code> file like this:</p><pre><code>subscription <span class="call">messagesReceived</span>($threadID: <span class="type">ID</span>!) {
  <span class="call">messagesReceived</span>(threadID: $threadID) {
    id
    date
    text
    author
  }
}
</code></pre><p>Once this is done we use Apollo iOS SDK to auto-generate type-safe Swift code. Which can be used in our app.</p><p>You can read more about using Apollo iOS SDK in my previous <a href="/graphql-ios-swift/">post</a>.</p><h2>Setting up the client</h2><p>Setting up the Apollo client using subscriptions can be the trickiest step, so let's go through it.</p><p>First, we need to create <code>WebSocketTransport</code> instance to send GraphQL subscription operations to the server.</p><pre><code><span class="keyword">let</span> webSocketTransport: <span class="type">WebSocketTransport</span> = {
  <span class="keyword">let</span> url = <span class="type">URL</span>(string: <span class="string">"ws://messaging.app/websocket"</span>)!
  <span class="keyword">let</span> request = <span class="type">URLRequest</span>(url: url)
  <span class="keyword">return</span> <span class="type">WebSocketTransport</span>(request: request)
}()
</code></pre><p>Then an HTTP transport instance will help us to use queries and mutations.</p><pre><code><span class="keyword">let</span> httpTransport = <span class="type">HTTPNetworkTransport</span>(url: <span class="type">URL</span>(string: <span class="string">"http://messaging.app/graphql"</span>)!)
</code></pre><p>A split network transport allows the use of HTTP Transport and WebSocket transport protocols. That enables us to avoid any potential issues of having multiple client objects.</p><pre><code><span class="keyword">let</span> splitNetworkTransport = <span class="type">SplitNetworkTransport</span>(
  httpNetworkTransport: httpTransport, 
  webSocketNetworkTransport: webSocketTransport
)
</code></pre><p>Then we create the Apollo client using network transport type which in this case is <code>SplitNetworkTransport</code>.</p><pre><code><span class="keyword">let</span> apolloClient = <span class="type">Apollo</span>(networkTransport: splitTransport)
</code></pre><h2>Using the subscription</h2><p>After we have created the Apollo client with subscription capabilities we can use it in our app to listen when a new message has been created to the specific thread.</p><pre><code><span class="keyword">let</span> receivedMessagesSubscription = <span class="type">MessagesReceivedSubscription</span>(id: threadID)
<span class="keyword">let</span> messagesSubsription = apolloClient.<span class="call">subscribe</span>(subscription: receivedMessagesSubscription) {[<span class="keyword">weak self</span>] result <span class="keyword">in
  switch</span> result {
  <span class="keyword">case</span> .<span class="dotAccess">success</span>(<span class="keyword">let</span> graphQLResult):
      <span class="keyword">if let</span> message = graphQLResult.<span class="property">data</span>.<span class="property">message</span> {
        <span class="call">print</span>(<span class="string">"Message received</span> \(message)<span class="string">"</span>)			
      }
  <span class="keyword">case</span> .<span class="dotAccess">failure</span>(<span class="keyword">let</span> error):
      <span class="call">print</span>(<span class="string">"Failed to subscribe</span> \(error)<span class="string">"</span>)
  }
}
</code></pre><p>Each time when a message has been sent, code inside closure is executed with new data.</p><h2>TL;DR</h2><p>GraphQL is not only for fetching data from the server and updating data on the server. You can be using GraphQL subscription feature to listen and send real-time messages using WebSockets.</p><p>Apollo iOS SDK library has the functionality to support subscriptions in your Swift applications. It is using WebSocket library Starscream behind the scenes to offload this cumbersome task. By leveraging code generation you can use strictly typed Swift code to interact with your GraphQL server in real-time in your iOS, iPadOS, macOS and tvOS apps.</p><h2>Links</h2><ul><li><a href="https://www.apollographql.com/docs/ios/subscriptions/">Apollo iOS SDK library subscriptions documentation</a></li><li><a href="https://stackoverflow.com/questions/51720378/how-to-implement-graphql-subscription-using-apollo-ios-client">Some use cases setting up Apollo iOS SDK</a></li><li><a href="https://www.apollographql.com/docs/react/data/subscriptions/">Apollo SDK official subscriptions documentation</a></li></ul></div></div></section></div><footer class="footer">Copyright © Kristaps Grinbergs. 2020</footer></body></html>